<!DOCTYPE html>
<html lang="ko">

<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Sample</title>
</head>

<body>
	<h1>Sample</h1>
	<h3>글 목록</h3>
	<div id="list">
	</div>
	<button onclick="list()">조회하기</button>
	<hr>
	<h3>글 입력</h3>
	<div id="insert">
		<div class="input-group">
			<input type="text" id="title" name="title" placeholder="title"><br>
			<input type="text" id="content" name="content" placeholder="content"><br>
			<input type="text" id="author" name="author" placeholder="author"><br>
		</div>
		<button onclick="add()">작성하기</button>
	</div>
	<hr>
	<h3>글 상세</h3>
	<div id="detail"></div>
	<hr>
	<h3>제목으로 검색</h3>
	<div class="search">
		<input type="text" id="search-title" placeholder="제목으로 검색">
		<button onclick="searchByTitle()">검색</button>
	</div>
	<script>
		async function fetchAPI(url, option) {
			const response = await fetch(url, option);
			if (response.ok) {
				return response.json();
			} else {
				throw new Error(response.statusText);
			}
		}

		async function list(title) {
			let url = "http://localhost:8080/post";
			if (title) {
				url += "?title=" + encodeURIComponent(title);
			}

			const posts = await fetchAPI(url);
			const tbody = posts.map(post => `<tr>
						<td>${post.id}</td>
						<td><a href="#" onclick="read(${post.id})">${post.title}</a></td>
						<td>${post.content}</td>
						<td>${post.author}</td>
						<td>${post.createdDate}</td>
				</tr>`).join('');

			document.getElementById("list").innerHTML =
				`<table>
			         <thead>
			           <tr>
			             <th>글 번호</th>
			             <th>제목</th>
			             <th>작성자</th>
			             <th>생성일자</th>
			           </tr>
			         </thead>
         			 <tbody>${tbody}</tbody>
       			</table>`;
		};

		async function add() {
			const title = document.getElementById("title").value;
			const content = document.getElementById("content").value;
			const author = document.getElementById("author").value;

			if (!title) return;
			const post = await fetchAPI("http://localhost:8080/post", {
				method: "POST",
				headers: {"Content-Type": "application/json"},
				body: JSON.stringify({
					title: title,
					content: content ? content : null,
					author: author ? author : null
				})
			});
			read(post.id);
		};

		async function read(id) {

			const post = await fetchAPI(`http://localhost:8080/post/${id}`);

			let tbody = `<tr>
						<td>${post.id}</td>
						<td>${post.title}</td>
						<td>${post.content}</td>
						<td>${post.author}</td>
						<td>${post.createdDate}</td>
				</tr>`;

			document.getElementById("detail").innerHTML =
				`<table>
			         <thead>
			           <tr>
			             <th>글 번호</th>
			             <th>제목</th>
			             <th>내용</th>
			             <th>작성자</th>
			             <th>생성일자</th>
			           </tr>
			         </thead>
         			 <tbody>${tbody}</tbody>
       			</table>
       			<div> 
		            <button onclick="update(${post.id})">수정하기</button> 
		            <button onclick="remove(${post.id})">삭제하기</button> 
        		</div>`;
		}

		async function remove(id) {
			await fetch(`http://localhost:8080/post/${id}`, {
				method: "DELETE"
			});
			alert("삭제되었습니다.");
			document.getElementById("detail").innerHTML = ""
			list();
		}

		async function update(id) {
			const post = await fetchAPI(`http://localhost:8080/post/${id}`);

			document.getElementById("detail").innerHTML =
				`<div class="input-group">
					<input type="text" id="update-title" name="title" placeholder="title" value="${post.title}"><br>
					<input type="text" id="update-content" name="content" placeholder="content" value="${post.content}"><br>
					<input type="text" id="update-author" name="author" placeholder="author" value="${post.author}"><br>
				</div>
				<div>
					<button onclick="updateSubmit(${id})">수정하기</button> 
					<button onclick="read(${id})">취소하기</button> 
				</div>`;
		};

		async function updateSubmit(id) {
			const title = document.getElementById("update-title").value;
			const content = document.getElementById("update-content").value;
			const author = document.getElementById("update-author").value;

			const post = await fetch(`http://localhost:8080/post/${id}`, {
				method: "PUT",
				headers: {"Content-Type": "application/json"},
				body: JSON.stringify({
					title: title,
					content: content ? content : null,
					author: author ? author : null
				})
			});
			alert("수정되었습니다.");
			read(id);

		}

		async function searchByTitle() {
			const title = document.getElementById("search-title").value;

			if (!title) return;

			await list(title);
		}

	</script>
</body>

</html>